!function s(i,n,r){function o(e,t){if(!n[e]){if(!i[e]){var a="function"==typeof require&&require;if(!t&&a)return a(e,!0);if(p)return p(e,!0);throw(a=new Error("Cannot find module '"+e+"'")).code="MODULE_NOT_FOUND",a}a=n[e]={exports:{}},i[e][0].call(a.exports,function(t){return o(i[e][1][t]||t)},a,a.exports,s,i,n,r)}return n[e].exports}for(var p="function"==typeof require&&require,t=0;t<r.length;t++)o(r[t]);return o}({1:[function(t,e,a){"use strict";t("./tagging"),t("./peepsotags")},{"./peepsotags":2,"./tagging":3}],2:[function(t,e,a){"use strict";var s,i;s=jQuery||$,i=peepso,function(p,d,h){function t(){}t.prototype.init=function(){var i=this;this.taggable_inputs=h.applyFilters("peepsotags_taggable_inputs",["#postbox-main textarea.ps-postbox-textarea"]);this.init_tags(this.taggable_inputs.join(","));this.init_tags_comments();p(document).on("peepso_tags_init_comments ps_activitystream_append ps_activitystream_loaded peepso_repost_added",function(){i.init_tags_comments()});p(document).on("ps_comment_added ps_comment_save",function(){i.init_tags_comments()});h.addFilter("postbox_req_edit",function(e,t){t.ps_tagging("val",function(t){e.post=t});return e},10,2);h.addFilter("comment_req",function(e,t){p(t).ps_tagging("val",function(t){e.content=t;e.post=t});return e},10,2);h.addFilter("comment_cancel",function(t){p(t).ps_tagging("reset")},10,2);h.addFilter("modalcomments.afterchange",function(t){if(t&&t.$attachment)t.$attachment.find(".ps-comment-reply textarea").ps_tagging()},10,2);h.addFilter("caption_req",function(e,t){p(t).ps_tagging("val",function(t){e.description=t});return e},10,2);h.addFilter("comment.reply",function(t,e){if(e.id!=peepsodata.currentuserid)if(e.id&&e.name){var a=_.template(peepsotagsdata.template);t.val(a({id:e.id,title:e.name})+" ");t.removeData("ps_tagging");i.init_tags_comments(t)}},10,2);p("#peepso-wrap").on("comment.saved",function(t,e,a,s){p(a).ps_tagging("reset");return});p("#peepso-wrap").on("post_edit.shown",function(t,e,a){var s=a.find("textarea");i.init_tags(s)});h.addAction("comment_edit",p.proxy(function(t,e){var a=p(e).find("textarea");this.init_tags(a)},this),10,2);h.addAction("postbox_update",p.proxy(function(t){this.init_tags(t.$text)},this),10,1);h.addFilter("postbox_data",function(e,t){t.$text.ps_tagging("val",function(t){e.content=t});return e},10,2)},t.prototype.init_tags=function(t){var i=false,n=false,r;p(t).one("focus.get_taggable",function(){var t=h.applyFilters("tags_get_taggable_params",{});i=true;d.postJson("tagsajax.get_taggable",t,function(t){if(t.success)r=t.data.users;if(typeof n==="function")n(r||[]);i=false})});p(t).ps_tagging({syntax:_.template(peepsotagsdata.template),parser:new RegExp(peepsotagsdata.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function t(e,a){if(r){a(r,"cache");return}if(i){n=a;return}var s=h.applyFilters("tags_get_taggable_params",{});d.postJson("tagsajax.get_taggable",s,function(t){if(t.success)r=t.data.users;a(r||[])})}})},t.prototype.init_tags_comments=function(t){if(!t)t='[data-type="stream-newcomment"] textarea[name="comment"]';p(t).each(function(t,i){var n=false,r=false,o;p(i).off("focus.get_taggable");p(i).one("focus.get_taggable",function(){var t=h.applyFilters("tags_get_taggable_params",{act_id:p(i).data("act-id")});n=true;d.postJson("tagsajax.get_taggable",t,function(t){if(t.success)o=t.data.users;if(typeof r==="function")r(o||[]);n=false})});p(i).ps_tagging({syntax:_.template(peepsotagsdata.template),parser:new RegExp(peepsotagsdata.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function t(e,a){if(o){a(o,"cache");return}if(n){r=a;return}var s=h.applyFilters("tags_get_taggable_params",{act_id:p(i).data("act-id")});d.postJson("tagsajax.get_taggable",s,function(t){if(t.success)o=t.data.users;a(o||[])})}});h.addFilter("comment_can_submit",function(t){var e=p(t.el).data("ps_tagging");if(e.dropdown_is_visible)t.can_submit=false;return t},20,1);p(i).ps_autosize()})},t.prototype.apply_line_breaks=function(t){var e=t;if(e.wrap)e.setAttribute("wrap","off");else e.setAttribute("wrap","off");var a=e.value;e.value="";var s=e.scrollWidth;var i=-1;function r(t){e.value=t;return e.scrollWidth>s}function o(t,e,a){var s;if("undefined"===typeof e){e=0;a=-1;s=64}else if(-1===a)s=e*2;else if(a-e<=1)return Math.max(2,a);else s=e+(a-e)/2;var i=t.substr(0,s);var n=r(i);if(n)a=s;else{if(s>=t.length)return null;e=s}return o(t,e,a)}var n=0,p;var d="";while(n<a.length){var h=o(a.substr(n));if(null===h){d+=a.substr(n);break}i=-1;var g=h-1;for(p=g-1;p>=0;p--){var l=a.charAt(n+p);if(" "===l||"-"===l||"+"===l){g=p+1;break}}d+=a.substr(n,g)+"\n";n+=g}e.value=d;e.setAttribute("wrap","")};var i=new t;p(function(){i.init();p(".ps-postbox-tab.interactions .ps-button-cancel").on("click",function(){p("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")});p("#postbox-main").on("postbox.post_cancel",function(){p("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")})}),h.addFilter("peepso_postbox_addons",function(t){t.push({init:p.noop,set_postbox:function t(e){var a=e.attr("id")==="postbox-main";var s=e.hasClass("ps-postbox-message");if(!(a||s))return;if(!e.$textarea.hasClass("ps-tagging-textarea"))i.init_tags(e.$textarea);h.addFilter("postbox_req_"+e.guid,function(e){p("#postbox-main textarea.ps-postbox-textarea").eq(0).ps_tagging("val",function(t){e.content=t});return e},10,1)}});return t},10,1)}(s,i,i.observer)},{}],3:[function(t,e,a){"use strict";function i(t){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function s(t,e){return this.textarea=t,this.options=e||{},this.init(),this}var n,r,o,p,d,h,g,l,u,c,f,x,v,m,w,y,b,$,S,k,F;n=jQuery,r=_,o=peepso,p=n,d=r,h=13,g=27,l=38,u=40,c=/@\[\[(\d+):user:([^\]]+)\]\]/g,f=/@\[\[(\d+):user:([^\]]+)\]\]/,x=".ps-tagging",v=".ps-tagging-textarea",m=".ps-postbox__input-tag",w=".ps-postbox__input-beautifier",y=".ps-tagging-hidden",b=".ps-tagging-dropdown",$=".ps-tagging-dropdown-item",S=".active",k=".ps-tagging-loading",s.prototype.init=function(){this.dom_prepare(),this.textarea.value&&(this.parse_tags(),this.textarea_on_input()),this.$textarea.off(x).on("focus"+x,p.proxy(this.textarea_on_keydown,this)).on("click"+x,p.proxy(this.textarea_on_keydown,this)).on("keydown"+x,p.proxy(this.textarea_on_keydown,this)).on("keyup"+x,p.proxy(this.textarea_on_keyup,this)).on("input"+x,p.proxy(this.textarea_on_input,this)).on("blur"+x,p.proxy(this.textarea_on_blur,this)),this.$dropdown.off(x).on("mouseenter"+x,$,p.proxy(this.dropdown_on_mouseenter,this)).on("mousedown"+x,$,p.proxy(this.dropdown_on_mousedown,this)).on("mouseup"+x,$,p.proxy(this.dropdown_on_mouseup,this))},s.prototype.dom_prepare=function(){this.$textarea=p(this.textarea),this.$textarea.addClass(v.substr(1)),this.$wrapper=this.$textarea.parent(m),this.$wrapper.length||(this.$textarea.wrap('<div class="'+m.substr(1)+'"></div>'),this.$wrapper=this.$textarea.parent()),this.$beautifier=this.$wrapper.children(w),this.$beautifier.length||(this.$beautifier=p('<div class="'+w.substr(1)+'"></div>'),this.$beautifier.prependTo(this.$wrapper)),this.$hidden=this.$wrapper.children(y),this.$hidden.length||(this.$hidden=p('<input type="hidden" class="'+y.substr(1)+'">'),this.$hidden.appendTo(this.$wrapper)),this.$dropdown=this.$wrapper.children(b),this.$dropdown.length||(this.$dropdown=p('<div class="'+b.substr(1)+'"></div>'),this.$dropdown.appendTo(this.$wrapper))},s.prototype.parse_tags=function(){var t,e,a,s,i,n=this.textarea.value;if(this.options.parser&&(t=this.options.parser_groups||{},n=n.replace(this.options.parser,function(){return"@[["+(arguments[t.id]||"")+":user:"+(arguments[t.title]||"")+"]]"})),e=n.match(c),this.textarea.value=n.replace(c,"$2"),this.tags_added=[],e&&e.length)for(i=0;i<e.length;i++)a=e[i].match(f),s=n.indexOf(e[i]),n=n.replace(e[i],a[2]),this.tags_added.push({id:a[1],name:a[2],start:s,length:a[2].length})},s.prototype.reset=function(){this.textarea.value="";var t=this.tags_added=[],e=this;setTimeout(function(){e.$textarea.trigger("keyup"),e.$textarea.trigger("input")}),this.hidden_update("",t),this.dropdown_hide()},s.prototype.val=function(){var t=this.$hidden.val();return t="function"==typeof this.options.syntax?t.replace(/@\[\[(\d+):user:([^\]]+)\]\]/g,p.proxy(function(t,e,a){return this.options.syntax({id:e,title:a})},this)):t},s.prototype.textarea_on_keydown=function(t){var e=t.keyCode;this.dropdown_is_visible&&0<=[h,g,l,u].indexOf(e)&&(t.preventDefault(),t.stopPropagation()),this.prev_sel_start=this.textarea.selectionStart,this.prev_sel_end=this.textarea.selectionEnd},s.prototype.textarea_on_keyup=function(t){var e=t.keyCode;this.dropdown_is_visible&&(e!==l&&e!==u||(this.dropdown_change_item(e),t.preventDefault(),t.stopPropagation()),e===h&&(this.dropdown_select_item(),t.preventDefault(),t.stopPropagation()),e===g&&(this.dropdown_hide(),t.preventDefault(),t.stopPropagation()))},s.prototype.textarea_on_input=function(t){var e,a,s,i,n,r,o,p,d,h=this.textarea.value;if(this.tags_added){if(this.prev_sel_start!==this.prev_sel_end)for(p=0;p<this.tags_added.length;p++)s=(a=this.tags_added[p]).start+a.length,(this.prev_sel_start>a.start&&this.prev_sel_start<s||this.prev_sel_end>a.start&&this.prev_sel_end<s||a.start>=this.prev_sel_start&&s<=this.prev_sel_end)&&this.tags_added.splice(p--,1);for(e=this.textarea.selectionStart-this.prev_sel_start-(this.prev_sel_end-this.prev_sel_start),p=0;p<this.tags_added.length;p++)if((a=this.tags_added[p]).start>=this.prev_sel_start)a.start+=e;else if(s=a.start+a.length,!(s<this.prev_sel_start))if(s>this.prev_sel_start){if(0<e)this.tags_added.splice(p--,1);else if(e<0){for(r=(i=h.substring(a.start,this.prev_sel_start+e)).split(" ").length-1,(i=a.name.split(" ")).splice(r,1),i=i.join(" "),n=(n=(n=a.name.split(" ")).slice(0,r)).join(" "),r=new RegExp("^([\\s\\S]{"+a.start+"})([\\s\\S]{"+(a.length+e)+"})"),this.textarea.value=this.textarea.value.replace(r,"$1"+i),this.textarea.setSelectionRange(a.start+n.length,a.start+n.length),h=this.textarea.value,o=a.length-i.length,a.name=i,a.length=i.length,d=p+1;d<this.tags_added.length;d++)this.tags_added[d].start-=o;i.length||this.tags_added.splice(p--,1),p=this.tags_added.length}}else if(e<0){for((i=a.name.split(" ")).pop(),i=i.join(" "),r=new RegExp("^([\\s\\S]{"+a.start+"})([\\s\\S]{"+(a.length+e)+"})"),this.textarea.value=this.textarea.value.replace(r,"$1"+i),this.textarea.setSelectionRange(a.start+i.length,a.start+i.length),h=this.textarea.value,o=a.length-i.length,a.name=i,a.length=i.length,d=p+1;d<this.tags_added.length;d++)this.tags_added[d].start-=o;i.length||this.tags_added.splice(p--,1),p=this.tags_added.length}}this.hidden_update(h,this.tags_added||[]),this.dropdown_toggle()},s.prototype.textarea_on_blur=function(t){},s.prototype.beautifier_update=function(t,e){var a,s,i,n,r;if(e.length){for(a="^",s="",r=i=0;r<e.length;r++)a+="([\\s\\S]{"+((n=e[r]).start-i)+"})([\\s\\S]{"+n.length+"})",s+="$"+(2*r+1)+"[[["+n.name+"]]]",i=n.start+n.length;a=new RegExp(a),t=t.replace(a,s)}return t=t.replace(/\[\[\[([^\[\]]+)\]\]\]/g,'<ps_span class="ps-tag">$1</ps_span>')},s.prototype.hidden_update=d.debounce(function(t,e){var a,s,i,n,r;if(e.length){for(a="^",s="",r=i=0;r<e.length;r++)a+="([\\s\\S]{"+((n=e[r]).start-i)+"})([\\s\\S]{"+n.length+"})",s+="$"+(2*r+1)+"@[["+n.id+":user:"+n.name+"]]",i=n.start+n.length;a=new RegExp(a),t=t.replace(a,s)}this.$hidden.val(t)},50),s.prototype.dropdown_toggle=d.debounce(function(){var t=this.textarea.selectionStart,e=this.textarea.value.substr(0,t),a=e.lastIndexOf("@");a<0||0<a&&!e[a-1].match(/\s/)||++a>=t?this.dropdown_hide():(e=e.substring(a,t),this.dropdown_fetch(e,p.proxy(this.dropdown_update,this)))},200),s.prototype.dropdown_fetch=function(a,s){"function"==typeof this.options.fetcher?this.dropdown_fetching||(this.dropdown_fetching=!0,this.$dropdown.find(k).show(),this.options.fetcher(a,p.proxy(function(t,e){this.$dropdown.find(k).hide(),this.dropdown_fetching=!1,"cache"===e?s(a,t):this.dropdown_toggle()},this))):s(a,[])},s.prototype.dropdown_filter=function(e,t){var a=[];return this.tags_added&&this.tags_added.length&&(a=d.map(this.tags_added,function(t){return""+t.id})),e=e.toLowerCase(),d.filter(t,function(t){return-1===a.indexOf(""+t.id)&&-1<t.name.toLowerCase().indexOf(e)})},s.prototype.dropdown_update=function(t,e){var a,s;if((e=this.dropdown_filter(t,e)).length){for(a="",s=0;s<e.length;s++)a+='<div class="'+$.substr(1)+'" data-id="'+e[s].id+'" data-name="'+e[s].name+'">',a+='<a href="#" onclick="return false;"><div class="ps-avatar"><img src="'+e[s].avatar+'"></div><span>'+e[s].name+"</span></a>",a+="</div>";this.dropdown_show(a)}},s.prototype.dropdown_show=function(t){this.$dropdown.html(t).show(),this.dropdown_is_visible=!0},s.prototype.dropdown_show_more=function(){},s.prototype.dropdown_hide=function(){this.$dropdown.hide(),this.dropdown_is_visible=!1},s.prototype.dropdown_on_mouseenter=function(t){this.dropdown_change_item(t)},s.prototype.dropdown_on_mousedown=function(){this.dropdown_is_clicked=!0},s.prototype.dropdown_on_mouseup=function(t){this.dropdown_select_item(t),this.dropdown_is_clicked=!1,this.dropdown_hide()},s.prototype.dropdown_change_item=function(t){var e,a,s=S.substr(1);if("number"!=typeof t)return a=(e=this.dropdown_selected_item=p(t.target)).siblings(S),e.addClass(s),void a.removeClass(s);(e=this.$dropdown.children(S)).length?(a=e[t===l?"prev":"next"](),e.removeClass(s),a.length?(this.dropdown_selected_item=a).addClass(s):this.dropdown_selected_item=!1):(e=this.dropdown_selected_item=this.$dropdown.children()[t===l?"last":"first"]()).addClass(s)},s.prototype.dropdown_select_item=function(t){var e=t?p(t.currentTarget):this.dropdown_selected_item,a=e.data("id"),s=e.data("name"),t=this.textarea.selectionStart,e=this.textarea.value.substr(0,t).lastIndexOf("@");this.tags_added||(this.tags_added=[]),this.tags_added.push({id:a,name:s,start:e,length:s.length}),t=new RegExp("^([\\s\\S]{"+e+"})[\\s\\S]{"+(t-e)+"}"),t=this.textarea.value.replace(t,"$1"+s)+" ",this.textarea.value=t,this.textarea.setSelectionRange(e+s.length+1,e+s.length+1);var i=this;setTimeout(function(){i.$textarea.trigger("keyup"),i.$textarea.trigger("input")}),this.hidden_update(t,this.tags_added),this.dropdown_hide(),this.$textarea.focus()},F=s,n.fn.ps_tagging=function(a,s){return"object"===i(a)&&(s=a),this.each(function(){var t=n(this),e=t.data("ps_tagging");e||(e=new F(this,s),t.data("ps_tagging",e)),"val"===a&&"function"==typeof s?s(e.val()):"reset"===a&&e.reset()})},o.observer.addFilter("peepso_postbox_beautifier",function(t,e){var a=e.data("ps_tagging"),s=e.val(),e=a.tags_added||[];return a.beautifier_update(s,e)},10,2)},{}]},{},[1]);